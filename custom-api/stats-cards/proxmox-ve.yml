- type: custom-api
  css-class: glimpsable-custom glimpse-unique-proxmox-ve-stat-card
  frameless: true
  hide-header: true
  options:
    icon: ${DASHBOARD_ICONS}/svg/proxmox.svg
    link: //${PROXMOXVE_URL}
    title: Proxmox VE
    subtitle: Virtualization Platform
  cache: 1s
  template: | #html
    {{
      $data := newRequest "https://${PROXMOXVE_URL}/api2/json/cluster/resources"
        | withHeader "Accept" "application/json"
        | withHeader "Content-Type" "application/json"
        | withHeader "Authorization" "PVEAPIToken=${PROXMOXVE_KEY}"
        | getResponse
    }}
    $include: _stat-template.gohtml
    {{ template "main-container" }}
      {{ $endpoint1_ok := and (ge $data.Response.StatusCode 200) (le $data.Response.StatusCode 299) }}
      {{ template "status-badge-popover" }}
        <div data-popover-html>
          <div class="flex gap-7">
            {{ template "state-icon" $endpoint1_ok }}
            {{ template "status-endpoint-label" }}
            {{ template "status-endpoint-result" $data.Response.Status }}
          </div>
        </div>
        {{ template "status-badge" $endpoint1_ok }}
      </div>
      {{ template "layout-container" }}
        $include: _stat-main-title.gohtml
        {{ template "stat-container" }}
          {{ $nodes_online := len ($data.JSON.Array "data.#(type==\"node\")#|#(status==\"online\")#") | formatNumber }}
          {{ $nodes_total := len ($data.JSON.Array "data.#(type==\"node\")#") }}
          <div>
            {{ template "stat-value" (concat $nodes_online "/" ($nodes_total | formatNumber)) }}
            {{ template "stat-label" "Node" }}
          </div>
          <div>
            {{ $lxc_running := len ($data.JSON.Array "data.#(type==\"lxc\")#|#(status==\"running\")#|#(template==0)#") | formatNumber }}
            {{ $lxc_total := len ($data.JSON.Array "data.#(type==\"lxc\")#|#(template==0)#") | formatNumber }}
            {{ template "stat-value" (concat $lxc_running "/" $lxc_total) }}
            {{ template "stat-label" "LXC" }}
          </div>
          <div>
            {{ $qemu_running := len ($data.JSON.Array "data.#(type==\"qemu\")#|#(status==\"running\")#|#(template==0)#") | formatNumber }}
            {{ $qemu_total := len ($data.JSON.Array "data.#(type==\"qemu\")#|#(template==0)#") | formatNumber }}
            {{ template "stat-value" (concat $qemu_running "/" $qemu_total) }}
            {{ template "stat-label" "VM" }}
          </div>
          <div>
            {{ $storage_available := len ($data.JSON.Array "data.#(type==\"storage\")#|#(status==\"available\")#") | formatNumber }}
            {{ $storage_total := len ($data.JSON.Array "data.#(type==\"storage\")#") | formatNumber }}
            {{ template "stat-value" (concat $storage_available "/" $storage_total) }}
            {{ template "stat-label" "Storage" }}
          </div>
        </div>
      </div>
    </div>